name: Build Newifi3 D2 (Final Fix)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR + 22.04 Fix)'
          - '4.4 (MeIsReallyBa + Docker)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Ubuntu 22.04 Env
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo \
          libtirpc-dev pkg-config unzip \
          automake autoconf gettext
        sudo apt-get clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 0. 初始化变量与环境
        # =======================================================
        INPUT_VER="${{ github.event.inputs.target_version }}"
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        
        IS_KERNEL_44="false"
        TARGET_PROFILE=""
        
        if [[ "$INPUT_VER" == *"4.4"* ]]; then
            echo "Selection: Kernel 4.4 (MeIsReallyBa)"
            REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
            REPO_BRANCH="main"
            IS_KERNEL_44="true"
            # 4.4 源码中，新三的名字通常是 NEWIFI
            TARGET_PROFILE="NEWIFI" 
        else
            echo "Selection: Kernel 3.4 (Hanwckf)"
            REPO_URL="https://github.com/hanwckf/rt-n56u.git"
            REPO_BRANCH="master"
            IS_KERNEL_44="false"
            # 3.4 源码中，新三的名字通常是 NEWIFI3
            TARGET_PROFILE="NEWIFI3"
        fi

        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        echo "IS_KERNEL_44=$IS_KERNEL_44" >> $GITHUB_ENV
        echo "TARGET_PROFILE=$TARGET_PROFILE" >> $GITHUB_ENV
        
        # =======================================================
        # 1. 拉取源码
        # =======================================================
        echo "Cloning Source from $REPO_URL ..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        # =======================================================
        # 2. 准备工具链
        # =======================================================
        echo "Preparing Toolchain..."
        cd $WORK_DIR/toolchain-mipsel
        
        if [ -f "dl_toolchain.sh" ]; then
            sh dl_toolchain.sh
        fi
        
        sudo mkdir -p /opt/rt-n56u
        # 动态查找工具链目录，兼容不同命名
        TC_DIR=$(find $WORK_DIR/toolchain-mipsel -maxdepth 1 -type d -name "toolchain-*" | head -n 1)
        if [ -d "$TC_DIR" ]; then
            sudo ln -sf "$TC_DIR" /opt/rt-n56u/toolchain-mipsel
            echo "Linked $TC_DIR to /opt/rt-n56u/toolchain-mipsel"
        else
            echo "ERROR: Could not detect toolchain directory!"
            exit 1
        fi

        # =======================================================
        # 3. 分支处理逻辑
        # =======================================================
        
        cd $WORK_DIR/trunk
        
        if [ "$IS_KERNEL_44" == "true" ]; then
            # ---------------------------------------------------
            # 3.A: 4.4 版本处理 (修改 board.mk)
            # ---------------------------------------------------
            echo ">>> Configuring for Kernel 4.4 (Profile: $TARGET_PROFILE)..."
            
            # 4.4 的配置通常在 configs/boards/NEWIFI/board.mk
            CONFIG_FILE="configs/boards/$TARGET_PROFILE/board.mk"
            
            if [ ! -f "$CONFIG_FILE" ]; then
                echo "ERROR: Could not find config file: $CONFIG_FILE"
                echo "Available boards:"
                ls configs/boards
                exit 1
            fi
            
            echo "Modifying $CONFIG_FILE ..."
            # 4.4 精简插件
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $CONFIG_FILE
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $CONFIG_FILE
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $CONFIG_FILE
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_SMARTDNS=y/CONFIG_FIRMWARE_INCLUDE_SMARTDNS=n/g' $CONFIG_FILE
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $CONFIG_FILE
            # 开启 Flow Offload
            sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $CONFIG_FILE
            
            # 注意：4.4 不需要手动 cp 到 .config，build_firmware 脚本会读取 board.mk 自动生成
            
        else
            # ---------------------------------------------------
            # 3.B: 3.4 版本处理 (KVR + Fix + .config)
            # ---------------------------------------------------
            echo ">>> Configuring for Kernel 3.4 (Profile: $TARGET_PROFILE)..."
            
            # === 3.4 KVR 注入 ===
            KVR_TEMP="/tmp/padavan_kvr"
            git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git $KVR_TEMP
            DEST_DRIVER_DIR="$WORK_DIR/trunk/proprietary_driver/rt_wifi"
            SRC_MT7603=$(find $KVR_TEMP -type d -name "mt7603e*" -print -quit)
            SRC_MT7612=$(find $KVR_TEMP -type d -name "mt7612e*" -print -quit)
            
            if [ -n "$SRC_MT7603" ]; then rm -rf $DEST_DRIVER_DIR/mt7603e; cp -r "$SRC_MT7603" $DEST_DRIVER_DIR/mt7603e; fi
            if [ -n "$SRC_MT7612" ]; then rm -rf $DEST_DRIVER_DIR/mt7612e; cp -r "$SRC_MT7612" $DEST_DRIVER_DIR/mt7612e; fi
            rm -rf $KVR_TEMP
            
            # === 3.4 编译环境修复 ===
            if [ -d "$WORK_DIR/trunk/tools/mksquashfs_xz" ]; then
                cd $WORK_DIR/trunk/tools/mksquashfs_xz
                sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' Makefile
                cd $WORK_DIR/trunk
            fi
            cd $WORK_DIR/trunk/user/dropbear
            sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' Makefile
            cd $WORK_DIR/trunk
            
            # === 3.4 配置文件处理 ===
            # 3.4 必须手动把模板复制为 .config
            TEMPLATE_PATH="configs/templates/NEWIFI3.config"
            if [ ! -f "$TEMPLATE_PATH" ]; then TEMPLATE_PATH="configs/templates/newifi3.config"; fi
            
            cp -f $TEMPLATE_PATH .config
            
            # 修改 .config
            sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' .config
            sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' .config
            if ! grep -q "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR" .config; then
                echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> .config
            else
                sed -i 's/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=n/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y/g' .config
            fi
            
            # 3.4 精简
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' .config
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' .config
            sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' .config
        fi

        # =======================================================
        # 4. 开始编译
        # =======================================================
        echo "Starting Build for $TARGET_PROFILE..."
        
        # ！！！关键修正：不要在这里运行 make clean ！！！
        # ！！！ build_firmware 脚本会自动处理依赖 ！！！
        
        fakeroot ./build_firmware $TARGET_PROFILE
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/ 2>/dev/null || true
        
        if [ "$(ls -A ./output_firmware)" ]; then
           echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV
           echo "Build Success!"
        else
           echo "Build Failed. Check logs."
           exit 1
        fi

    - name: Upload Firmware
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-final
        name: Newifi3 AutoBuild ${{ env.DATE }}
        body: |
          Newifi3 D2 自动构建 (Ubuntu 22.04)
          - 内核: ${{ env.IS_KERNEL_44 == 'true' && '4.4 (MeIsReallyBa)' || '3.4 (Hanwckf)' }}
          - 机型代码: ${{ env.TARGET_PROFILE }}
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Newifi3 D2 (Smart KVR + 22.04 Fix)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Target Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + Smart KVR)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Ubuntu 22.04 Env
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo \
          libtirpc-dev pkg-config unzip \
          automake autoconf gettext
        sudo apt-get clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 1. 基础配置
        # =======================================================
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        
        # 使用 Hanwckf 源码 (最为稳健)
        REPO_URL="https://github.com/hanwckf/rt-n56u.git"
        REPO_BRANCH="master"
        TARGET_PROFILE="NEWIFI3"
        
        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        
        # =======================================================
        # 2. 拉取源码
        # =======================================================
        echo "Cloning Source..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        # =======================================================
        # 3. 准备工具链 (创建 /opt 软链接，防止路径报错)
        # =======================================================
        echo "Preparing Toolchain..."
        cd $WORK_DIR/toolchain-mipsel
        sh dl_toolchain.sh
        
        # 强制创建 /opt 路径链接
        sudo mkdir -p /opt/rt-n56u
        sudo ln -sf "$WORK_DIR/toolchain-mipsel/toolchain-3.4.x" /opt/rt-n56u/toolchain-mipsel
        
        # 验证一下
        if [ ! -f "/opt/rt-n56u/toolchain-mipsel/bin/mipsel-linux-uclibc-gcc" ]; then
            echo "ERROR: Toolchain link failed!"
            exit 1
        fi

        # =======================================================
        # 4. 【智能注入】KVR 补丁 (Smart Find)
        # =======================================================
        echo "Injecting KVR Patches..."
        KVR_TEMP="/tmp/padavan_kvr"
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git $KVR_TEMP
        
        # --- 调试步骤：列出文件结构，方便排错 ---
        echo "DEBUG: Listing KVR repo content:"
        ls -R $KVR_TEMP
        # ------------------------------------
        
        # Hanwckf 源码驱动目标路径
        DEST_DRIVER_DIR="$WORK_DIR/trunk/proprietary_driver/rt_wifi"
        
        # 智能查找：在下载的仓库里寻找名称包含 mt7603e 的文件夹
        # find ... -print -quit 会找到第一个匹配项就停止
        SRC_MT7603=$(find $KVR_TEMP -type d -name "mt7603e*" -print -quit)
        SRC_MT7612=$(find $KVR_TEMP -type d -name "mt7612e*" -print -quit)
        
        echo "Detected 2.4G Driver Source: $SRC_MT7603"
        echo "Detected 5G Driver Source: $SRC_MT7612"
        
        if [ -n "$SRC_MT7603" ]; then
            echo "Overwriting MT7603E driver..."
            rm -rf $DEST_DRIVER_DIR/mt7603e
            cp -r "$SRC_MT7603" $DEST_DRIVER_DIR/mt7603e
        else
            echo "WARNING: Could not find mt7603e in KVR repo! Using default."
        fi
        
        if [ -n "$SRC_MT7612" ]; then
            echo "Overwriting MT7612E driver..."
            rm -rf $DEST_DRIVER_DIR/mt7612e
            cp -r "$SRC_MT7612" $DEST_DRIVER_DIR/mt7612e
        else
            echo "WARNING: Could not find mt7612e in KVR repo! Using default."
        fi
        
        rm -rf $KVR_TEMP

        # =======================================================
        # 5. Ubuntu 22.04 兼容性补丁 (防止编译中断)
        # =======================================================
        
        # Fix: mksquashfs (xz)
        cd $WORK_DIR/trunk/tools/mksquashfs_xz
        sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' Makefile
        
        # Fix: e2fsprogs (configure 语法错误)
        cd $WORK_DIR/trunk/user/e2fsprogs
        sed -i 's/AM_GNU_GETTEXT(external)/# AM_GNU_GETTEXT(external)/g' configure.in || true
        autoreconf -ivf || true
        sed -i 's/.\/configure/.\/configure --disable-nls/g' Makefile

        # Fix: Dropbear (RPC 头文件缺失)
        cd $WORK_DIR/trunk/user/dropbear
        DB_DIR=$(find . -maxdepth 1 -type d -name "dropbear-*" | head -n 1)
        if [ -d "$DB_DIR" ]; then
           cd "$DB_DIR"
           autoreconf -ivf || true
           cd ..
        fi
        sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' Makefile
        
        # =======================================================
        # 6. 配置生成
        # =======================================================
        cd $WORK_DIR/trunk
        TEMPLATE_PATH="configs/templates/NEWIFI3.config"
        
        if [ ! -f "$TEMPLATE_PATH" ]; then
           echo "ERROR: NEWIFI3.config not found!"
           # 尝试查找小写
           TEMPLATE_PATH="configs/templates/newifi3.config"
           if [ ! -f "$TEMPLATE_PATH" ]; then exit 1; fi
        fi
        
        # 强制设置驱动版本以匹配 KVR 补丁 (关键)
        sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' $TEMPLATE_PATH
        
        # 开启 KVR 宏 (如果源码支持)
        if ! grep -q "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR" $TEMPLATE_PATH; then
            echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> $TEMPLATE_PATH
        else
            sed -i 's/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=n/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y/g' $TEMPLATE_PATH
        fi

        # 精简插件 (防止空间不足或编译其他插件报错)
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_XRAY=y/CONFIG_FIRMWARE_INCLUDE_XRAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_V2RAY=y/CONFIG_FIRMWARE_INCLUDE_V2RAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $TEMPLATE_PATH
        
        # 开启 Flow Offload
        sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $TEMPLATE_PATH

        cp -f $TEMPLATE_PATH .config
        
        # =======================================================
        # 7. 编译
        # =======================================================
        echo "Starting Build..."
        make clean
        fakeroot ./build_firmware $TARGET_PROFILE
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/ 2>/dev/null || true
        
        if [ "$(ls -A ./output_firmware)" ]; then
           echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV
           echo "Build Success!"
        else
           echo "Build Failed. Check logs."
           exit 1
        fi

    - name: Upload Firmware
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-kvr-fixed
        name: Newifi3 D2 (Hanwckf KVR SmartFix) ${{ env.DATE }}
        body: |
          Newifi3 D2 自动构建 (Ubuntu 22.04 Fixed)
          - 源码: Hanwckf
          - 特性: KVR Roaming (Auto-injected)
          - 修复: Toolchain Path, RPC, XZ, e2fsprogs
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

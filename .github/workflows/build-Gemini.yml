name: Build Newifi3 D2 (Gemini 3 Pro)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR)'
          - '4.4 (MeIsReallyBa)'

permissions:
  contents: write

env:
  TZ: Asia/Shanghai
  FIRMWARE_PATH: ${{ github.workspace }}/output_firmware

jobs:
  build:
    runs-on: ubuntu-latest
    
    # âš ï¸ è¯·ç¡®è®¤ä¸‹æ–¹ image åœ°å€ä¸ä½ å®é™…æ„å»ºçš„åœ°å€ä¸€è‡´
    # é€šå¸¸æ ¼å¼ä¸º: ghcr.io/ç”¨æˆ·å(å°å†™)/ä»“åº“å(å°å†™)/padavan-builder:latest
    container:
      image: ghcr.io/biaogo94/cleanpadavan-newifi3/padavan-builder:latest
      options: --user root

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Initialize Environment Variables
      id: init
      run: |
        # åˆ¤æ–­å†…æ ¸ç‰ˆæœ¬å¹¶è®¾ç½®å˜é‡
        if [[ "${{ github.event.inputs.target_version }}" == *"4.4"* ]]; then
          echo "KERNEL_VER=4.4" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/MeIsReallyBa/padavan-4.4.git" >> $GITHUB_ENV
          echo "REPO_BRANCH=main" >> $GITHUB_ENV
          echo "TARGET_PROFILE=NEWIFI" >> $GITHUB_ENV
        else
          echo "KERNEL_VER=3.4" >> $GITHUB_ENV
          echo "REPO_URL=https://github.com/hanwckf/rt-n56u.git" >> $GITHUB_ENV
          echo "REPO_BRANCH=master" >> $GITHUB_ENV
          echo "TARGET_PROFILE=NEWIFI3" >> $GITHUB_ENV
        fi
        
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "WORK_DIR=${{ github.workspace }}/padavan" >> $GITHUB_ENV

    - name: Clone Source Code
      run: |
        echo "Cloning ${{ env.KERNEL_VER }} source from ${{ env.REPO_URL }} ..."
        git clone --depth=1 --branch ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} ${{ env.WORK_DIR }}

    - name: Cache Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ env.WORK_DIR }}/toolchain-mipsel
        key: toolchain-${{ env.KERNEL_VER }}-${{ hashFiles(format('{0}/toolchain-mipsel/dl_toolchain.sh', env.WORK_DIR)) }}

    - name: Prepare Toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        cd ${{ env.WORK_DIR }}/toolchain-mipsel
        sh dl_toolchain.sh

    - name: Link Toolchain
      run: |
        mkdir -p /opt/rt-n56u
        sudo ln -sf ${{ env.WORK_DIR }}/toolchain-mipsel /opt/rt-n56u/toolchain-mipsel
        # ç®€å•éªŒè¯
        /opt/rt-n56u/toolchain-mipsel/toolchain-3.4.x/bin/mipsel-linux-uclibc-gcc --version || echo "Toolchain verification skipped"

    # --- 3.4 å†…æ ¸ä¸“å±é€»è¾‘ (KVR & Patch) ---
    - name: (Kernel 3.4) Apply KVR & Fixes
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}
        
        # 1. æ³¨å…¥ KVR è¡¥ä¸ (vb1980)
        echo "Applying KVR patches..."
        git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git /tmp/kvr
        
        DRIVER_DIR="trunk/proprietary_driver/rt_wifi"
        
        # [æ ¸å¿ƒä¿®å¤] ä½¿ç”¨ -name "xxx*" åŒ¹é…å¸¦åç¼€çš„ç›®å½•ï¼Œå¹¶ä½¿ç”¨ -print -quit åªå–ç¬¬ä¸€ä¸ª
        # æŸ¥æ‰¾ mt7603e
        SRC_7603=$(find /tmp/kvr -type d -name "mt7603e*" -print -quit)
        if [ -n "$SRC_7603" ]; then
            echo "âœ… Found mt7603e at: $SRC_7603"
            rm -rf $DRIVER_DIR/mt7603e
            cp -r "$SRC_7603" $DRIVER_DIR/mt7603e
        else
            echo "::error:: âŒ mt7603e driver not found in KVR repo!"
            exit 1
        fi

        # æŸ¥æ‰¾ mt7612e
        SRC_7612=$(find /tmp/kvr -type d -name "mt7612e*" -print -quit)
        if [ -n "$SRC_7612" ]; then
            echo "âœ… Found mt7612e at: $SRC_7612"
            rm -rf $DRIVER_DIR/mt7612e
            cp -r "$SRC_7612" $DRIVER_DIR/mt7612e
        else
             echo "::error:: âŒ mt7612e driver not found in KVR repo!"
             exit 1
        fi
        
        rm -rf /tmp/kvr

        # 2. ä¿®å¤ build å·¥å…·å…¼å®¹æ€§
        sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' trunk/tools/mksquashfs_xz/Makefile
        
        # 3. ä¿®å¤ Dropbear ç¼–è¯‘
        sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' trunk/user/dropbear/Makefile

    - name: (Kernel 3.4) Configure Target
      if: env.KERNEL_VER == '3.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        if [ -f "configs/templates/NEWIFI3.config" ]; then
            cp -f configs/templates/NEWIFI3.config .config
        else
            cp -f configs/templates/newifi3.config .config
        fi

        # å¼ºåˆ¶è®¾ç½®é©±åŠ¨ç‰ˆæœ¬
        sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' .config
        sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' .config
        
        # ç¡®ä¿ KVR å¼€å¯
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR/d' .config
        echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> .config

    # --- 4.4 å†…æ ¸ä¸“å±é€»è¾‘ ---
    - name: (Kernel 4.4) Configure Target
      if: env.KERNEL_VER == '4.4'
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        CONFIG_FILE="configs/boards/${{ env.TARGET_PROFILE }}/board.mk"
        
        if [ -f "$CONFIG_FILE" ]; then
            # å¼€å¯ç¡¬ä»¶åŠ é€Ÿ
            sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $CONFIG_FILE
            # å…³é—­å¸¸ç”¨æ’ä»¶
            for APP in ARIA TRANSMISSION OPENVPN SMARTDNS TROJAN; do
                sed -i "s/CONFIG_FIRMWARE_INCLUDE_${APP}=y/CONFIG_FIRMWARE_INCLUDE_${APP}=n/g" $CONFIG_FILE
            done
        else
            echo "::error:: Config file $CONFIG_FILE not found!"
            exit 1
        fi

    # --- é€šç”¨æ¸…ç†ä¸é…ç½® ---
    - name: Common Customization
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        if [ -f .config ]; then
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' .config
             sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' .config
             
             # [é‡è¦] ç¦ç”¨ RTL-SDR ä»¥é¿å… cmake ä¾èµ–æŠ¥é”™
             sed -i 's/CONFIG_FIRMWARE_INCLUDE_RTL_SDR=y/CONFIG_FIRMWARE_INCLUDE_RTL_SDR=n/g' .config
        fi

    # --- æ ¸å¿ƒç¼–è¯‘ ---
    - name: Compile Firmware
      run: |
        cd ${{ env.WORK_DIR }}/trunk
        ./clear_tree || true
        
        echo "Building for ${{ env.TARGET_PROFILE }}..."
        
        # 1. æ‰§è¡Œç¼–è¯‘
        fakeroot ./build_firmware ${{ env.TARGET_PROFILE }}
        
        # 2. ç«‹å³æ£€æŸ¥äº§ç‰©
        if [ ! -f images/*.trx ]; then
            echo "::error:: âŒ Compilation failed! No .trx file generated."
            exit 1
        else
            echo "âœ… Compilation successful. Firmware found."
        fi

    # --- æ•´ç†äº§ç‰© ---
    - name: Organize Artifacts
      run: |
        mkdir -p ${{ env.FIRMWARE_PATH }}
        find ${{ env.WORK_DIR }}/trunk/images -name "*.trx" -exec cp {} ${{ env.FIRMWARE_PATH }}/ \;
        ls -lh ${{ env.FIRMWARE_PATH }}

    # --- ä¸Šä¼  Release ---
    - name: Upload Firmware to Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.BUILD_DATE }}-${{ env.KERNEL_VER }}
        name: Newifi3 D2 Padavan ${{ env.KERNEL_VER }} (${{ env.BUILD_DATE }})
        body: |
          ### ğŸš€ Newifi3 D2 è‡ªåŠ¨æ„å»º (ä¿®å¤ç‰ˆ)
          
          | ä¿¡æ¯ | è¯´æ˜ |
          | :--- | :--- |
          | **å†…æ ¸ç‰ˆæœ¬** | ${{ env.KERNEL_VER }} |
          | **æºç ä»“åº“** | ${{ env.REPO_URL }} |
          | **æ„å»ºæ—¥æœŸ** | ${{ env.BUILD_DATE }} |
          
          ### âœ¨ ç‰¹æ€§
          * âš¡ **Flow Offload**: å·²å¼€å¯
          * ğŸ“¶ **WIFI KVR**: ${{ env.KERNEL_VER == '3.4' && 'âœ… æ”¯æŒ (vb1980 patch)' || 'âš ï¸ åŸç”Ÿ' }}
          * ğŸ§¹ **ç²¾ç®€ç‰ˆ**: ç§»é™¤ Aria2/Transmission/RTL-SDR
          
          ### ğŸ›  ä½¿ç”¨æ–¹æ³•
          åœ¨ Breed Web æ¢å¤æ§åˆ¶å°ä¸­ä¸Šä¼  `.trx` æ–‡ä»¶è¿›è¡Œæ›´æ–°ã€‚
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

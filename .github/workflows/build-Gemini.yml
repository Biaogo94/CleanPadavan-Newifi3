name: Build Newifi3 D2 (Fixed 4.4 Config Path)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Select Kernel Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (Hanwckf + KVR + 22.04 Fix)'
          - '4.4 (MeIsReallyBa + Docker)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Ubuntu 22.04 Env
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo \
          libtirpc-dev pkg-config unzip \
          automake autoconf gettext
        sudo apt-get clean
        sudo timedatectl set-timezone Asia/Shanghai

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 0. 识别选择的版本
        # =======================================================
        INPUT_VER="${{ github.event.inputs.target_version }}"
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p $WORK_DIR
        
        # 初始化变量
        IS_KERNEL_44="false"
        
        if [[ "$INPUT_VER" == *"4.4"* ]]; then
            echo "Selection: Kernel 4.4 (MeIsReallyBa)"
            REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
            REPO_BRANCH="main"
            IS_KERNEL_44="true"
        else
            echo "Selection: Kernel 3.4 (Hanwckf)"
            REPO_URL="https://github.com/hanwckf/rt-n56u.git"
            REPO_BRANCH="master"
            IS_KERNEL_44="false"
        fi

        TARGET_PROFILE="NEWIFI3"
        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        echo "IS_KERNEL_44=$IS_KERNEL_44" >> $GITHUB_ENV
        
        # =======================================================
        # 1. 拉取源码
        # =======================================================
        echo "Cloning Source from $REPO_URL ..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL $WORK_DIR
        
        # =======================================================
        # 2. 准备工具链
        # =======================================================
        echo "Preparing Toolchain..."
        cd $WORK_DIR/toolchain-mipsel
        
        if [ -f "dl_toolchain.sh" ]; then
            sh dl_toolchain.sh
        else
            echo "Notice: dl_toolchain.sh not found, assuming toolchain exists."
        fi
        
        # 强制创建 /opt 路径链接
        sudo mkdir -p /opt/rt-n56u
        # 动态查找工具链目录 (4.4 和 3.4 目录名可能不同)
        TC_DIR=$(find $WORK_DIR/toolchain-mipsel -maxdepth 1 -type d -name "toolchain-*" | head -n 1)
        if [ -d "$TC_DIR" ]; then
            sudo ln -sf "$TC_DIR" /opt/rt-n56u/toolchain-mipsel
            echo "Linked $TC_DIR to /opt/rt-n56u/toolchain-mipsel"
        else
            echo "ERROR: Could not detect toolchain directory!"
            exit 1
        fi

        # =======================================================
        # 3. 【分支逻辑】仅针对 3.4 版本的特殊处理
        # =======================================================
        if [ "$IS_KERNEL_44" == "false" ]; then
            echo ">>> Applying 3.4 specific patches (KVR + 22.04 Fixes)..."
            
            # --- 3.1 注入 KVR (仅 3.4) ---
            KVR_TEMP="/tmp/padavan_kvr"
            git clone --depth=1 https://github.com/vb1980/Padavan-KVR.git $KVR_TEMP
            
            DEST_DRIVER_DIR="$WORK_DIR/trunk/proprietary_driver/rt_wifi"
            SRC_MT7603=$(find $KVR_TEMP -type d -name "mt7603e*" -print -quit)
            SRC_MT7612=$(find $KVR_TEMP -type d -name "mt7612e*" -print -quit)
            
            if [ -n "$SRC_MT7603" ]; then
                rm -rf $DEST_DRIVER_DIR/mt7603e
                cp -r "$SRC_MT7603" $DEST_DRIVER_DIR/mt7603e
            fi
            if [ -n "$SRC_MT7612" ]; then
                rm -rf $DEST_DRIVER_DIR/mt7612e
                cp -r "$SRC_MT7612" $DEST_DRIVER_DIR/mt7612e
            fi
            rm -rf $KVR_TEMP
            
            # --- 3.2 修复 Ubuntu 22.04 编译报错 (仅 3.4) ---
            if [ -d "$WORK_DIR/trunk/tools/mksquashfs_xz" ]; then
                cd $WORK_DIR/trunk/tools/mksquashfs_xz
                sed -i 's/$(MAKE) -C $(XZ_DIR)/sed -i "s\/ po \/ \/g" $(XZ_DIR)\/Makefile; $(MAKE) -C $(XZ_DIR)/g' Makefile
            fi
            
            cd $WORK_DIR/trunk/user/dropbear
            sed -i 's|./configure|export CFLAGS="-I/usr/include/tirpc"; export LIBS="-ltirpc"; ./configure|g' Makefile
            
        else
            echo ">>> Kernel 4.4 selected. Skipping 3.4 legacy patches."
        fi

        # =======================================================
        # 4. 配置生成 (关键修复步骤)
        # =======================================================
        cd $WORK_DIR/trunk
        
        # 4.0 智能查找配置文件 (修复 4.4 找不到配置的问题)
        echo "Searching for config file..."
        FOUND_CONFIG=""
        
        # 优先级列表：
        # 1. 标准 templates 目录 (3.4)
        # 2. boards 目录 (4.4 常见)
        
        PATH_LIST=(
            "configs/templates/NEWIFI3.config"
            "configs/templates/newifi3.config"
            "configs/boards/NEWIFI3/NEWIFI3.config"
            "configs/boards/NEWIFI3/board.config"
        )
        
        for p in "${PATH_LIST[@]}"; do
            if [ -f "$p" ]; then
                FOUND_CONFIG="$p"
                echo "✅ Config found at: $p"
                break
            fi
        done
        
        if [ -z "$FOUND_CONFIG" ]; then
            echo "❌ ERROR: Config file not found for NEWIFI3!"
            echo "Debug info - Listing directories:"
            ls -R configs/boards || true
            exit 1
        fi
        
        # 如果是在 boards 目录找到的，必须把它复制到 templates 目录
        # 这样 build_firmware 脚本才能通过 NEWIFI3 这个名字找到它
        if [[ "$FOUND_CONFIG" != "configs/templates/NEWIFI3.config" ]]; then
            echo "Copying $FOUND_CONFIG to configs/templates/NEWIFI3.config ..."
            cp "$FOUND_CONFIG" "configs/templates/NEWIFI3.config"
        fi
        
        TEMPLATE_PATH="configs/templates/NEWIFI3.config"

        # --- 4.1 3.4 版本特定的配置 ---
        if [ "$IS_KERNEL_44" == "false" ]; then
            sed -i 's/CONFIG_FIRMWARE_WIFI2_DRIVER=.*$/CONFIG_FIRMWARE_WIFI2_DRIVER=5.0/g' $TEMPLATE_PATH
            sed -i 's/CONFIG_FIRMWARE_WIFI5_DRIVER=.*$/CONFIG_FIRMWARE_WIFI5_DRIVER=3.0/g' $TEMPLATE_PATH
            
            if ! grep -q "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR" $TEMPLATE_PATH; then
                echo "CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y" >> $TEMPLATE_PATH
            else
                sed -i 's/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=n/CONFIG_FIRMWARE_INCLUDE_WIFI_KVR=y/g' $TEMPLATE_PATH
            fi
        fi
        
        # --- 4.2 通用精简配置 (适用于 3.4 和 4.4) ---
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_ARIA=y/CONFIG_FIRMWARE_INCLUDE_ARIA=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=y/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENVPN=y/CONFIG_FIRMWARE_INCLUDE_OPENVPN=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=y/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_XRAY=y/CONFIG_FIRMWARE_INCLUDE_XRAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_V2RAY=y/CONFIG_FIRMWARE_INCLUDE_V2RAY=n/g' $TEMPLATE_PATH
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_TROJAN=y/CONFIG_FIRMWARE_INCLUDE_TROJAN=n/g' $TEMPLATE_PATH
        
        # 开启 Flow Offload
        sed -i 's/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=n/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y/g' $TEMPLATE_PATH

        # 确保 .config 生成
        cp -f $TEMPLATE_PATH .config
        
        # =======================================================
        # 5. 编译
        # =======================================================
        echo "Starting Build..."
        
        # 4.4 有时需要先清理旧的 obj
        make clean
        
        # 调用构建脚本
        fakeroot ./build_firmware $TARGET_PROFILE
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/ 2>/dev/null || true
        
        if [ "$(ls -A ./output_firmware)" ]; then
           echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV
           echo "Build Success!"
        else
           echo "Build Failed. Check logs."
           exit 1
        fi

    - name: Upload Firmware
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-multi
        name: Newifi3 AutoBuild ${{ env.DATE }}
        body: |
          Newifi3 D2 自动构建 (Ubuntu 22.04)
          - 内核: ${{ env.IS_KERNEL_44 == 'true' && '4.4 (MeIsReallyBa)' || '3.4 (Hanwckf)' }}
          - 状态: Build Successful
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

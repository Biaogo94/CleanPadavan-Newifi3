name: Build Newifi3 D2 Padavan (Gemini 3 Pro)

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: '选择固件版本 / Firmware Version'
        required: true
        default: '3.4'
        type: choice
        options:
          - '3.4 (hanwckf - Stable/Legacy)'
          - '4.4 (MeIsReallyBa - Kernel 4.4)'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout CI Scripts
      uses: actions/checkout@v4

    - name: Prepare Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libtool-bin curl cmake gperf gawk flex bison \
          nano xxd fakeroot kmod cpio git-doc vim-common \
          libncurses5-dev libncurses5 \
          python3-docutils autopoint texinfo
        sudo apt-get clean

    - name: Run Compilation Logic
      run: |
        # =======================================================
        # 1. 初始化与变量定义
        # =======================================================
        WORK_DIR="$GITHUB_WORKSPACE/padavan"
        mkdir -p "$WORK_DIR"
        TOOLCHAIN_DIR="$WORK_DIR/toolchain-mipsel"
        
        CURRENT_DATE=$(date +%Y%m%d)
        echo "DATE=$CURRENT_DATE" >> $GITHUB_ENV
        
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
          REPO_URL="https://github.com/hanwckf/rt-n56u.git"
          REPO_BRANCH="master"
          echo "Selected Version: 3.4 (hanwckf)"
          echo "BUILD_VER=3.4" >> $GITHUB_ENV
          TARGET_PROFILE="NEWIFI3"
          KERNEL_DIR_NAME="linux-3.4.x"
        else
          REPO_URL="https://github.com/MeIsReallyBa/padavan-4.4.git"
          REPO_BRANCH="main"
          echo "Selected Version: 4.4 (MeIsReallyBa)"
          echo "BUILD_VER=4.4" >> $GITHUB_ENV
          TARGET_PROFILE="newifi3"
          KERNEL_DIR_NAME="linux-4.4.x"
        fi
        
        # =======================================================
        # 2. 拉取源码
        # =======================================================
        echo "Cloning source code..."
        git clone --depth=1 --branch $REPO_BRANCH $REPO_URL "$WORK_DIR"
        
        # =======================================================
        # 3. 【全能修复包】针对 3.4 版本的核心修复
        # =======================================================
        if [[ "${{ inputs.target_version }}" == *"3.4"* ]]; then
            echo "Applying strict fixes for 3.4..."
            
            # --- Fix 1: xz (Tools) ---
            # 禁用 NLS，跳过 po 目录，解决 mv: cannot stat 't-fr.gmo'
            MKSQ_MAKEFILE="$WORK_DIR/trunk/tools/mksquashfs_xz/Makefile"
            if [ -f "$MKSQ_MAKEFILE" ]; then
                sed -i 's/.\/configure/.\/configure --disable-nls/g' "$MKSQ_MAKEFILE"
            fi
            XZ_SRC="$WORK_DIR/trunk/tools/mksquashfs_xz/xz-5.2.4"
            if [ -f "$XZ_SRC/Makefile.in" ]; then
                sed -i 's/SUBDIRS.*=.*/SUBDIRS = src/g' "$XZ_SRC/Makefile.in"
            fi
            
            # --- Fix 2: e2fsprogs (User) ---
            # 屏蔽不支持的宏
            E2FS_CFG="$WORK_DIR/trunk/user/e2fsprogs/configure"
            if [ -f "$E2FS_CFG" ]; then
                sed -i 's/AM_GNU_GETTEXT(external)/# AM_GNU_GETTEXT(external)/g' "$E2FS_CFG"
                sed -i 's/AM_GNU_GETTEXT_VERSION/# AM_GNU_GETTEXT_VERSION/g' "$E2FS_CFG"
                touch "$E2FS_CFG"
            fi

            # --- Fix 3: dropbear (User) --- [关键修正]
            DROPBEAR_MK="$WORK_DIR/trunk/user/dropbear/Makefile"
            if [ -f "$DROPBEAR_MK" ]; then
                echo "Patching dropbear Makefile..."
                # 1. 移除 autoreconf 防止新版本工具破坏配置
                sed -i 's/autoreconf -v;//g' "$DROPBEAR_MK"
                
                # 2. 移除旧的未加引号的参数，防止冲突
                # 使用转义 \$ 来匹配 literal $
                sed -i 's/CC=\$(CC)//g' "$DROPBEAR_MK"
                sed -i 's/CFLAGS=\$(CFLAGS)//g' "$DROPBEAR_MK"
                sed -i 's/LDFLAGS=\$(LDFLAGS)//g' "$DROPBEAR_MK"
                
                # 3. 注入带引号的环境变量和 LIBS
                # 使用单引号 '...' 确保内部的双引号 "..." 被原样写入 Makefile
                # 这样 CC="$(CC)" 会被 Shell 正确识别，不会报 -mips32r2 not found
                # LIBS="-lz -lcrypt" 解决 zlib missing
                sed -i 's|./configure|CC="$(CC)" CFLAGS="$(CFLAGS)" LDFLAGS="$(LDFLAGS)" LIBS="-lz -lcrypt" ./configure|g' "$DROPBEAR_MK"
            fi
        fi

        # =======================================================
        # 4. 【注入配置】生成完整标准配置
        # =======================================================
        cd "$WORK_DIR/trunk/configs/templates"
        
        echo "Injecting FULL Standard Config for $TARGET_PROFILE..."
        # 使用 echo 逐行写入，避免 EOF 解析错误
        echo "CONFIG_VENDOR=ralink" > "$TARGET_PROFILE.config"
        echo "CONFIG_PRODUCT=MT7621" >> "$TARGET_PROFILE.config"
        echo "CONFIG_LINUXDIR=$KERNEL_DIR_NAME" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_PRODUCT_ID=\"NEWIFI3\"" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_CPU_MT7621=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_MEMORY_512M=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_FLASH_32M=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_ENABLE_USB=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_INCLUDE_HTTPS=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_INCLUDE_SFTP=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_INCLUDE_DROPBEAR=y" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_WIFI2_DRIVER=3.0" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_WIFI5_DRIVER=3.0" >> "$TARGET_PROFILE.config"
        echo "CONFIG_FIRMWARE_ENABLE_IPV6=y" >> "$TARGET_PROFILE.config"
        
        cd "$WORK_DIR/trunk"
        TEMPLATE_PATH="configs/templates/$TARGET_PROFILE.config"

        # =======================================================
        # 5. 准备 Toolchain
        # =======================================================
        echo "Preparing Toolchain..."
        cd "$TOOLCHAIN_DIR"
        sh dl_toolchain.sh
        
        # 建立软链接，欺骗老源码的硬编码路径
        echo "Setting up symlink for toolchain..."
        sudo mkdir -p /opt/rt-n56u
        sudo ln -sf "$TOOLCHAIN_DIR/toolchain-3.4.x" /opt/rt-n56u/toolchain-mipsel
        
        # 强制导出 PATH
        export PATH="/opt/rt-n56u/toolchain-mipsel/bin:$PATH"
        
        if ! command -v mipsel-linux-uclibc-gcc &> /dev/null; then
            echo "ERROR: Toolchain setup failed!"
            exit 1
        fi

        # =======================================================
        # 6. 修改配置 (插件净化)
        # =======================================================
        cd "$WORK_DIR/trunk"
        echo "Customizing $TEMPLATE_PATH..."
        
        sed -i '/CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD/d' "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_ENABLE_FLOWOFFLOAD=y" >> "$TEMPLATE_PATH"
        
        # 先删除，防止重复
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ARIA/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_TRANSMISSION/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_WGET/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_OPENVPN/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_TROJAN/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_V2RAY/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_XRAY/d' "$TEMPLATE_PATH"
        sed -i '/CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN/d' "$TEMPLATE_PATH"

        # 再写入
        echo "CONFIG_FIRMWARE_INCLUDE_ARIA=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_TRANSMISSION=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_WGET=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_OPENVPN=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_SHADOWSOCKS=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_SSSERVER=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_TROJAN=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_V2RAY=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_XRAY=n" >> "$TEMPLATE_PATH"
        echo "CONFIG_FIRMWARE_INCLUDE_SOFTETHERVPN_SERVER=n" >> "$TEMPLATE_PATH"

        # =======================================================
        # 7. 开始编译
        # =======================================================
        cp -f "$TEMPLATE_PATH" .config
        
        echo "Starting Pre-build (Libs)..."
        # 强制语言环境
        export LC_ALL=C
        
        # 清理残余
        make clean
        
        # 【关键步骤】先编译基础库，确保 zlib/openssl 就位
        fakeroot make libs
        
        echo "Starting Full Build..."
        # 编译完整固件
        fakeroot ./build_firmware "$TARGET_PROFILE"
        
    - name: Organize Artifacts
      run: |
        mkdir -p ./output_firmware
        cp ${{ github.workspace }}/padavan/trunk/images/*.trx ./output_firmware/
        echo "FIRMWARE_PATH=./output_firmware" >> $GITHUB_ENV

    - name: Upload Firmware to Releases
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v${{ env.DATE }}-newifi3-${{ env.BUILD_VER }}
        name: Newifi3 D2 Padavan ${{ env.BUILD_VER }} (${{ env.DATE }})
        body: |
          自动构建固件 (Newifi3 D2)
          - 机型: Newifi3 D2 (NEWIFI3)
          - 版本: Padavan ${{ env.BUILD_VER }}
          - 编译日期: ${{ env.DATE }}
          - 插件: 纯净版
          - 硬件加速: 开启 (Flow Offload)
        files: ${{ env.FIRMWARE_PATH }}/*.trx
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
